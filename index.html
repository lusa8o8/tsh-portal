<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSH PORTAL - Week 2: Quality Gate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="sidebar.css">
    <script src="sidebar-toggle.js" defer></script>
    <style>
        /* Sidebar Scrollability (Task 2.12) */
        .sidebar {
            overflow-y: auto;
            max-height: 100vh;
            padding-bottom: 20px;
        }

        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }

        /* Assessment Card Enhancements (Task 2.12) */
        .assessment-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .assessment-card.pressure-high {
            border-left: 3px solid #dc3545;
        }

        .assessment-card.pressure-medium {
            border-left: 3px solid #ffc107;
        }

        .assessment-card.pressure-low {
            border-left: 3px solid #28a745;
        }

        .assessment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .assessment-header h3 {
            margin: 0;
            font-size: 16px;
            color: #212529;
        }

        .pressure-badge {
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .pressure-badge.pressure-high {
            background: #f8d7da;
            color: #721c24;
        }

        .pressure-badge.pressure-medium {
            background: #fff3cd;
            color: #856404;
        }

        .pressure-badge.pressure-low {
            background: #d4edda;
            color: #155724;
        }

        .assessment-date {
            margin: 0;
            font-size: 14px;
            color: #6c757d;
        }

        /* Overview Instructions Styling (Task 2.13) */
        .intro-text {
            color: #6c757d;
            font-size: 14px;
            line-height: 1.6;
            margin: 0 0 25px 0;
            padding: 15px;
            background: #e7f3ff;
            border-radius: 4px;
            border-left: 3px solid #007bff;
        }

        .instruction-section {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #007bff;
        }

        .section-title {
            margin: 0 0 10px 0;
            font-size: 17px;
            font-weight: 600;
            color: #495057;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-intro {
            margin: 0 0 15px 0;
            padding: 10px;
            background: #e9ecef;
            border-radius: 4px;
            font-size: 13px;
            color: #495057;
            font-style: italic;
        }

        .instruction-section .help-list {
            margin: 0;
            padding-left: 0;
            list-style: none;
        }

        .instruction-section .help-list li {
            margin-bottom: 16px;
            line-height: 1.5;
            position: relative;
            padding-left: 20px;
        }

        .instruction-section .help-list li:before {
            content: "‚Üí";
            position: absolute;
            left: 0;
            color: #007bff;
            font-weight: bold;
        }

        .instruction-section .help-list li:last-child {
            margin-bottom: 0;
        }

        .action-path {
            display: inline-block;
            color: #007bff;
            font-weight: 500;
            margin-left: 4px;
        }

        .help-subtext {
            color: #6c757d;
            font-size: 13px;
            margin-top: 4px;
            line-height: 1.4;
        }

        /* Task 3.3: Instruction CSS Styles */
        .instruction-section strong {
            display: block;
            color: #2d3748;
            font-size: 14px;
            margin-bottom: 2px;
        }

        .action-path {
            display: inline-block;
            background: #edf2f7;
            padding: 2px 8px;
            border-radius: 4px;
            color: #2b6cb0;
            font-size: 12px;
            font-weight: 600;
            margin: 4px 0 6px 0;
            border: 1px solid #e2e8f0;
        }

        .instruction-section .help-list li:before {
            content: "‚úì";
            color: #38a169;
            font-size: 14px;
        }

        .instruction-section {
            border-left: 4px solid #3182ce;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .section-title {
            color: #2d3748;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 8px;
            margin-bottom: 15px;
        }

        .intro-text {
            background: #ebf8ff;
            color: #2c5282;
            border-left: 4px solid #3182ce;
        }

        .help-footer {
            background: #fffaf0;
            border-left: 4px solid #ed8936;
            color: #7b341e;
        }

        .inline-sop-link {
            color: #007bff;
            text-decoration: none;
            font-weight: 500;
        }

        .inline-sop-link:hover {
            text-decoration: underline;
        }

        .help-footer {
            margin-top: 30px;
            padding: 15px;
            background: #fff3cd;
            border-radius: 4px;
            border-left: 3px solid #ffc107;
        }

        .help-footer p {
            margin: 0;
            color: #856404;
            font-size: 14px;
            font-weight: 500;
        }

        .form-row {
            display: flex;
            gap: 1rem;
        }

        .form-row>* {
            flex: 1;
        }

        /* Coordination & Promotion Cards */
        .coordination-list,
        .promotion-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 15px;
        }

        .coordination-card,
        .promotion-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .coordination-card:hover,
        .promotion-card:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .card-header h3 {
            margin: 0;
            color: #333;
            font-size: 18px;
        }

        .badge-free {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-paid {
            background: #fff3e0;
            color: #f57c00;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .card-body p {
            margin: 8px 0;
            color: #666;
            font-size: 14px;
        }

        .card-body p strong {
            color: #333;
            font-weight: 600;
        }

        .promo-details {
            margin-bottom: 15px;
        }

        .promo-actions {
            display: flex;
            gap: 10px;
            padding-top: 10px;
            border-top: 1px solid #f0f0f0;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
            font-style: italic;
        }

        /* Scannable task list styling */
        .help-list li {
            margin-bottom: 16px;
            line-height: 1.5;
        }

        .action-path {
            display: inline-block;
            color: #495057;
            font-weight: 500;
            margin-left: 4px;
        }

        .help-subtext {
            color: #6c757d;
            font-size: 13px;
            margin-top: 4px;
            padding-left: 0;
            line-height: 1.4;
        }

        .inline-sop-link {
            color: #007bff;
            text-decoration: none;
            font-weight: 500;
        }

        .inline-sop-link:hover {
            text-decoration: underline;
        }

        /* Metric hints */
        .metric-card {
            position: relative;
            padding-bottom: 35px;
            /* Make room for hint */
        }

        .metric-hint {
            position: absolute;
            bottom: 10px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 12px;
            font-weight: 500;
            display: block;
        }

        .metric-hint-success {
            color: #28a745;
        }

        .metric-hint-neutral {
            color: #6c757d;
        }

        .metric-hint-action a {
            color: #007bff;
            text-decoration: none;
            font-weight: 600;
        }

        .metric-hint-action a:hover {
            text-decoration: underline;
        }

        /* SOP Cards Layout */
        .sop-links-section {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
        }

        .sop-links-section h4 {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 16px;
            font-weight: 600;
        }

        .sop-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 12px;
        }

        .sop-card {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 14px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            text-decoration: none;
            color: inherit;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .sop-card:hover {
            border-color: #007bff;
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.15);
            transform: translateY(-2px);
        }

        .sop-icon {
            font-size: 28px;
            line-height: 1;
            flex-shrink: 0;
        }

        .sop-content {
            flex: 1;
            min-width: 0;
            /* Allow text truncation */
        }

        .sop-content strong {
            display: block;
            color: #212529;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
            line-height: 1.3;
        }

        .sop-content small {
            display: block;
            color: #6c757d;
            font-size: 12px;
            line-height: 1.4;
        }

        /* Auth Container */
        .auth-container {
            max-width: 500px;
            margin: 50px auto;
            padding: 30px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-header h1 {
            margin: 0 0 20px 0;
            color: #2c3e50;
        }

        .auth-toggle {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .toggle-btn {
            padding: 8px 24px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #495057;
            transition: all 0.2s;
        }

        .toggle-btn:hover {
            background: #e9ecef;
        }

        .toggle-btn.active {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
        }

        /* Form Sections */
        .form-section-header {
            margin: 25px 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }

        .form-section-header h3 {
            margin: 0 0 5px 0;
            font-size: 16px;
            color: #495057;
        }

        .form-section-header small {
            color: #6c757d;
            font-size: 13px;
        }

        /* Sidebar Section Dividers */
        .nav-section-header {
            padding: 16px 24px 8px;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #7f8c8d;
            border-top: 1px solid #34495e;
            margin-top: 10px;
        }

        .nav-section-header:first-of-type {
            border-top: none;
            margin-top: 0;
        }

        /* Subject Selection */
        .subject-selection-group {
            margin-bottom: 15px;
        }

        .form-row {
            display: flex;
            gap: 15px;
        }

        .field-hint {
            display: block;
            font-size: 11px;
            color: #6c757d;
            margin-top: 2px;
        }

        .hint-success {
            color: #10b981;
        }

        .hint-warning {
            color: #f59e0b;
        }

        /* User Management */
        .view-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 0;
        }

        .tab-btn {
            padding: 10px 20px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            color: #495057;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            color: #2563eb;
        }

        .tab-btn.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
        }

        .tab-btn .badge {
            background: #dc3545;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 5px;
        }

        .user-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pending-card {
            border-left: 4px solid #ffc107;
        }

        .user-info h3 {
            margin: 0 0 10px 0;
            color: #212529;
            font-weight: 700;
        }

        .user-info p {
            margin: 5px 0;
            font-size: 14px;
            color: #495057;
        }

        .user-actions {
            display: flex;
            gap: 10px;
        }

        .users-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        .users-table th,
        .users-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
            font-size: 14px;
        }

        .users-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        .role-badge,
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .role-tutor {
            background: #eff6ff;
            color: #2563eb;
        }

        .role-hod {
            background: #faf5ff;
            color: #9333ea;
        }

        .role-admin {
            background: #fffbeb;
            color: #d97706;
        }

        .role-content_manager {
            background: #f0fdf4;
            color: #16a34a;
        }

        .role-marketing {
            background: #fdf2f8;
            color: #db2777;
        }

        .role-crm {
            background: #f0fdfa;
            color: #0d9488;
        }

        .role-finance {
            background: #fffdec;
            color: #ca8a04;
        }

        .status-pending {
            background: #fffbeb;
            color: #b45309;
        }

        .status-approved {
            background: #f0fdf4;
            color: #16a34a;
        }

        .status-rejected {
            background: #fef2f2;
            color: #dc2626;
        }

        .btn-success {
            background: #10b981;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
        }
    </style>
</head>

<body class="bg-gray-50 font-sans">
    <div id="root"></div>

    <script>
        // --- Vanilla JS State Management ---
        const state = {
            user: null,
            currentTab: 'overview',
            loading: true,
            dashboardData: null,
            notifications: [],
            unreadCount: 0,
            campaigns: [],
            assets: [],
            assessments: [],
            sessions: [],
            sopLinks: [],
            hubInventory: []
        };

        const API_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' ? 'http://localhost:3001/api' : '/api';

        const api = {
            async request(endpoint, options = {}) {
                const token = localStorage.getItem('token');
                const headers = { 'Content-Type': 'application/json', ...(token && { 'Authorization': `Bearer ${token}` }), ...options.headers };
                const res = await fetch(`${API_URL}${endpoint}`, { ...options, headers });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Request failed');
                return data;
            },
            login: (email, password) => api.request('/login', { method: 'POST', body: JSON.stringify({ email, password }) }),
            register: (data) => api.request('/register', { method: 'POST', body: JSON.stringify(data) }),
            getMe: () => api.request('/auth/me'),
            // User Management (Task 1.6)
            getUsers: (params = {}) => {
                const query = new URLSearchParams(params).toString();
                return api.request(`/users${query ? '?' + query : ''}`);
            },
            approveUser: (id) => api.request(`/users/${id}/approve`, { method: 'PATCH' }),
            rejectUser: (id, reason) => api.request(`/users/${id}/reject`, { method: 'PATCH', body: JSON.stringify({ reason }) }),
            // Campaigns (Week 1)
            getCampaigns: (params = {}) => {
                const query = new URLSearchParams(params).toString();
                return api.request(`/campaigns${query ? '?' + query : ''}`);
            },
            createCampaign: (d) => api.request('/campaigns', { method: 'POST', body: JSON.stringify(d) }),
            updateCampaign: (id, status, reason) => api.request(`/campaigns/${id}`, { method: 'PATCH', body: JSON.stringify({ status, reason }) }),
            // Assets (Week 2)
            getAssets: () => api.request('/assets'),
            createAsset: (d) => api.request('/assets', { method: 'POST', body: JSON.stringify(d) }),
            updateAsset: (id, status, hod_feedback) => api.request(`/assets/${id}`, { method: 'PATCH', body: JSON.stringify({ status, hod_feedback }) }),
            publishAsset: (id) => api.request(`/assets/${id}/publish`, { method: 'PATCH' }),
            requestRevision: (id, reason) => api.request(`/assets/${id}/request-revision`, { method: 'PATCH', body: JSON.stringify({ reason }) }),
            getFreeContent: () => api.request('/assets/free-content'),
            // Notifications & Dashboard (Week 5)
            getNotifications: (role) => api.request(`/notifications?role=${role}`),
            markNotificationRead: (id) => api.request(`/notifications/${id}/read`, { method: 'PATCH' }),
            getDashboard: () => api.request('/dashboard'),
            // Assessments (Week 3)
            getAssessments: () => api.request('/assessments'),
            createAssessment: (d) => api.request('/assessments', { method: 'POST', body: JSON.stringify(d) }),
            // Support Sessions (Week 3)
            getSessions: (params = {}) => {
                const query = new URLSearchParams(params).toString();
                return api.request(`/support_sessions${query ? '?' + query : ''}`);
            },
            createSession: (d) => api.request('/support_sessions', { method: 'POST', body: JSON.stringify(d) }),
            updateSession: (id, d) => api.request(`/support_sessions/${id}`, { method: 'PATCH', body: JSON.stringify(d) }),
            // Week 4: Outcomes & Inventory
            logCampaignOutcome: (id, data) => api.request(`/campaigns/${id}/outcome`, { method: 'PATCH', body: JSON.stringify(data) }),
            getHubInventory: () => api.request('/hub/inventory'),
            // Week 7.5: SOP Links
            getSopLinks: (params = {}) => {
                const query = new URLSearchParams(params).toString();
                return api.request(`/sop-links${query ? '?' + query : ''}`);
            },
            createSopLink: (data) => api.request('/sop-links', { method: 'POST', body: JSON.stringify(data) }),
            updateSopLink: (id, data) => api.request(`/sop-links/${id}`, { method: 'PATCH', body: JSON.stringify(data) }),
            deleteSopLink: (id) => api.request(`/sop-links/${id}`, { method: 'DELETE' })
        };

        // Helper function: Check if user has HOD-level permissions
        function isHODOrAdmin(user) {
            if (!user || !user.role) return false;
            return user.role === 'hod' || user.role === 'admin';
        }

        // Helper function for SOP icons
        function getSopIcon(title) {
            const t = (title || '').toLowerCase();
            if (t.includes('campaign')) return 'üì¢';
            if (t.includes('asset') || t.includes('content')) return 'üì§';
            if (t.includes('assessment')) return 'üó∫Ô∏è';
            if (t.includes('support') || t.includes('session')) return 'ü§ù';
            if (t.includes('register') || t.includes('user')) return 'üë§';
            return 'üìÅ';
        }

        // --- Core Rendering Engine ---
        async function renderApp() {
            const root = document.getElementById('root');
            if (state.loading) {
                root.innerHTML = '<div class="flex h-screen items-center justify-center text-gray-400">Loading...</div>';
                return;
            }

            if (!state.user) {
                root.innerHTML = renderLoginPage();
                return;
            }

            root.innerHTML = await renderDashboard();
            // Initialize sidebar toggles and other dynamic behaviors
            initDashboardBehaviors();
        }

        async function loadDashboardData() {
            if (!state.user) return;
            try {
                // Determine target role for SOP links
                const targetRole = state.user.role;
                const [dash, sops] = await Promise.all([
                    api.getDashboard(),
                    api.getSopLinks({ target_role: targetRole, active: true })
                ]);
                state.dashboardData = dash.counts || {};
                state.sopLinks = sops || [];
                renderApp();
            } catch (e) {
                console.error('Failed to load dashboard data:', e);
                state.dashboardData = {}; // Prevent infinite loading
                renderApp();
            }
        }

        // --- Init Function ---
        async function onInit() {
            const token = localStorage.getItem('token');
            if (token) {
                try {
                    const data = await api.getMe();
                    state.user = data.user;
                    // Proactively load dashboard data
                    loadDashboardData();
                } catch (e) {
                    localStorage.removeItem('token');
                    state.user = null;
                }
            }
            state.loading = false;
            renderApp();
        }

        // --- Auth Functions ---
        window.login = async (e) => {
            e.preventDefault();
            const form = e.target;
            const email = form.email.value;
            const password = form.password.value;
            const errEl = document.getElementById('auth-error');
            if (errEl) errEl.style.display = 'none';

            try {
                const { token, user } = await api.login(email, password);
                localStorage.setItem('token', token);
                state.user = user;
                renderApp();
            } catch (e) {
                if (errEl) {
                    errEl.innerText = e.message;
                    errEl.style.display = 'block';
                }
            }
        };

        window.logout = () => {
            localStorage.removeItem('token');
            state.user = null;
            renderApp();
        };

        window.setAuthMode = (mode) => {
            state.authMode = mode;
            renderApp();
        };

        // --- Login Page Component ---
        function renderLoginPage() {
            const mode = state.authMode || 'login';
            const subjects = ['Math', 'Physics', 'Chemistry', 'Biology'];
            const levels = [{ val: 'HS', label: 'High School' }, { val: 'Uni', label: 'University' }];

            return `
                <div class="flex min-h-screen items-center justify-center px-4 py-12">
                    <div class="auth-container w-full">
                        <div class="auth-header">
                            <h1 class="text-3xl font-black tracking-tighter text-black">TSH PORTAL</h1>
                            <div class="auth-toggle">
                                <button
                                    class="toggle-btn ${mode === 'login' ? 'active' : ''}"
                                    onclick="setAuthMode('login')"
                                >Login</button>
                                <button
                                    class="toggle-btn ${mode === 'register' ? 'active' : ''}"
                                    onclick="setAuthMode('register')"
                                >Sign Up</button>
                            </div>
                        </div>

                        <div id="auth-error" class="bg-red-50 text-red-600 p-4 rounded-lg mb-6 text-sm font-medium border border-red-100 hidden"></div>
                        <div id="auth-success" class="bg-green-50 text-green-700 p-4 rounded-lg mb-6 text-sm font-medium border border-green-100 hidden"></div>

                        ${mode === 'login' ? `
                            <form onsubmit="login(event)">
                                <div class="mb-4">
                                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Email Address</label>
                                    <input type="email" name="email" placeholder="Email" class="w-full border p-3 rounded-lg text-sm bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition-all" required />
                                </div>
                                <div class="mb-6">
                                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Password</label>
                                    <input type="password" name="password" placeholder="Password" class="w-full border p-3 rounded-lg text-sm bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition-all" required />
                                </div>
                                <button class="w-full bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-lg font-bold text-sm transition-colors shadow-lg shadow-blue-200">Sign In</button>
                            </form>
                        ` : `
                            <form onsubmit="register(event)">
                                <div class="mb-4">
                                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Full Name *</label>
                                    <input type="text" name="name" placeholder="John Doe" class="w-full border p-3 rounded-lg text-sm bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition-all" required />
                                </div>

                                <div class="mb-4">
                                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Email Address *</label>
                                    <input type="email" name="email" placeholder="john@example.com" class="w-full border p-3 rounded-lg text-sm bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition-all" required />
                                </div>

                                <div class="grid grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Password *</label>
                                        <input type="password" name="password" id="reg-password" placeholder="Minimal 8 chars" class="w-full border p-3 rounded-lg text-sm bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition-all" minLength="8" required />
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Confirm *</label>
                                        <input type="password" name="confirmPassword" id="reg-confirm" placeholder="Confirm" class="w-full border p-3 rounded-lg text-sm bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition-all" required />
                                    </div>
                                </div>

                                <div class="form-section-header">
                                    <h3>Subject Specialization</h3>
                                    <small>Select up to 2 subjects you can teach</small>
                                </div>

                                <div class="subject-selection-group">
                                    <div class="form-row">
                                        <div class="flex-1">
                                            <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Subject 1 *</label>
                                            <select name="subject1" class="w-full border p-2 rounded text-sm bg-white" required>
                                                <option value="">-- Select --</option>
                                                ${subjects.map(s => `<option value="${s}">${s}</option>`).join('')}
                                            </select>
                                        </div>
                                        <div class="flex-1">
                                            <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Level 1 *</label>
                                            <select name="level1" class="w-full border p-2 rounded text-sm bg-white" required>
                                                <option value="">-- Select --</option>
                                                ${levels.map(l => `<option value="${l.val}">${l.label}</option>`).join('')}
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div class="subject-selection-group">
                                    <div class="form-row">
                                        <div class="flex-1">
                                            <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Subject 2 (Opt)</label>
                                            <select name="subject2" class="w-full border p-2 rounded text-sm bg-white">
                                                <option value="">-- Select --</option>
                                                ${subjects.map(s => `<option value="${s}">${s}</option>`).join('')}
                                            </select>
                                        </div>
                                        <div class="flex-1">
                                            <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Level 2</label>
                                            <select name="level2" class="w-full border p-2 rounded text-sm bg-white">
                                                <option value="">-- Select --</option>
                                                ${levels.map(l => `<option value="${l.val}">${l.label}</option>`).join('')}
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <button class="w-full bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-lg font-bold text-sm transition-colors mt-4">Create Account</button>
                            </form>
                        `}
                    </div>
                </div>
            `;
        }

        window.register = async (e) => {
            e.preventDefault();
            const form = e.target;
            const name = form.name.value;
            const email = form.email.value;
            const password = form.password.value;
            const confirmPassword = form.confirmPassword.value;
            const subject1 = form.subject1.value;
            const level1 = form.level1.value;
            const subject2 = form.subject2.value;
            const level2 = form.level2.value;

            const errEl = document.getElementById('auth-error');
            const successEl = document.getElementById('auth-success');
            if (errEl) errEl.style.display = 'none';
            if (successEl) successEl.style.display = 'none';

            if (password !== confirmPassword) {
                if (errEl) { errEl.innerText = 'Passwords do not match'; errEl.style.display = 'block'; }
                return;
            }

            const subjects = [`${subject1} (${level1})`];
            if (subject2 && level2) subjects.push(`${subject2} (${level2})`);

            try {
                const data = await api.register({ name, email, password, subjects });
                if (successEl) {
                    successEl.innerText = data.message;
                    successEl.style.display = 'block';
                }
                setTimeout(() => setAuthMode('login'), 2000);
            } catch (e) {
                if (errEl) {
                    errEl.innerText = e.message;
                    errEl.style.display = 'block';
                }
            }
        };
        // --- Placeholder View ---
        function renderPlaceholderView(title) {
            return `
                <div class="bg-white rounded-xl shadow-sm border p-12 text-center mt-8">
                    <h2 class="text-2xl font-bold mb-4">${title}</h2>
                    <p class="text-gray-500">This module is under development and will be available soon.</p>
                </div>
            `;
        }

        window.setTab = (tabId) => {
            state.currentTab = tabId;
            renderApp();
            // Load data for the new tab
            loadTabData(tabId);
        };

        async function loadTabData(tabId) {
            const role = state.user.role;
            if (tabId === 'overview') {
                const d = await api.getDashboard();
                state.dashboardData = d.counts;
                const sops = await api.getSopLinks({ target_role: role, active: true });
                state.sopLinks = sops;
                renderApp();
            } else if (tabId === 'inbox') {
                const d = await api.getNotifications(role);
                state.notifications = d.notifications;
                state.unreadCount = d.notifications.filter(n => n.read_status === 'unread').length;
                renderApp();
            }
            // Other tab data loading will be added here
        }

        async function renderDashboard() {
            const { user, currentTab, unreadCount } = state;
            const tabs = [
                { id: 'overview', icon: 'üìä', label: 'Overview', roles: ['tutor', 'hod', 'admin', 'content_manager', 'marketing', 'crm'] },
                { id: 'inbox', icon: 'üì¨', label: 'Inbox', roles: ['tutor', 'hod', 'admin', 'content_manager', 'marketing', 'crm'] },
                { id: 'user-management', icon: 'üë•', label: 'User Management', roles: ['admin'] },
                { id: 'queue', icon: 'üì¶', label: 'Asset Queue', roles: ['content_manager'] },
                { id: 'campaigns', icon: user.role === 'marketing' ? 'üì¢' : 'üìÖ', label: 'Campaigns', roles: ['tutor', 'hod', 'admin', 'marketing', 'crm'] },
                { id: 'assets', icon: 'üì§', label: 'Upload Queue', roles: ['tutor', 'admin'] },
                { id: 'assessments', icon: 'üìã', label: 'Assessment Map', roles: ['tutor', 'hod', 'admin'] },
                { id: 'sessions', icon: 'üéØ', label: 'Support Sessions', roles: ['tutor', 'hod', 'admin'] },
                { id: 'sop-management', icon: '‚öôÔ∏è', label: 'SOP Management', roles: ['hod', 'admin'] },
                { id: 'hub', icon: 'üìö', label: 'Study Hub', roles: ['tutor', 'hod', 'admin'] },
                { id: 'strategic', icon: 'üìä', label: 'Strategic View', roles: ['tutor', 'hod', 'admin', 'content_manager', 'marketing', 'crm'] }
            ].filter(t => t.roles.includes(user.role));

            return `
                <div class="flex min-h-screen">
                    <button id="hamburger-btn" class="md:hidden fixed top-4 right-4 z-50 bg-[#2c3e50] text-white p-2 rounded shadow">‚ò∞</button>
                    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>

                    <aside class="sidebar w-[240px] bg-[#2c3e50] text-[#ecf0f1] fixed inset-y-0 left-0 z-40 flex flex-col pt-6 md:translate-x-0">
                        <div class="px-6 mb-8 flex flex-col relative">
                            <h1 class="text-[18px] font-bold">TSH PORTAL</h1>
                            <p class="text-sm mt-1">${user.name}</p>
                            <p class="text-xs text-gray-400">(${user.role})</p>
                            <button onclick="logout()" class="text-xs text-blue-300 underline absolute top-6 right-6 hover:text-white transition-colors">Logout</button>
                        </div>

                        <nav class="sidebar-nav flex-1">
                            ${isHODOrAdmin(user) ? `
                                <div class="nav-section-header">Core</div>
                                <a href="#" onclick="event.preventDefault(); setTab('overview')" class="nav-link flex items-center px-6 py-3 transition-colors ${currentTab === 'overview' ? 'bg-[#3498db] font-bold text-white' : 'hover:bg-[#34495e]'}">
                                    <span class="mr-3">üìä</span> Overview
                                </a>
                                <a href="#" onclick="event.preventDefault(); setTab('inbox')" class="nav-link flex items-center px-6 py-3 transition-colors relative ${currentTab === 'inbox' ? 'bg-[#3498db] font-bold text-white' : 'hover:bg-[#34495e]'}">
                                    <span class="mr-3">üì¨</span> Inbox ${unreadCount > 0 ? `<span class="notification-badge">${unreadCount}</span>` : ''}
                                </a>

                                <div class="nav-section-header">Teaching Functions</div>
                                <a href="#" onclick="event.preventDefault(); setTab('campaigns')" class="nav-link flex items-center px-6 py-3 transition-colors ${currentTab === 'campaigns' ? 'bg-[#3498db] font-bold text-white' : 'hover:bg-[#34495e]'}">
                                    <span class="mr-3">üìÖ</span> My Campaigns
                                </a>
                                <a href="#" onclick="event.preventDefault(); setTab('assessments')" class="nav-link flex items-center px-6 py-3 transition-colors ${currentTab === 'assessments' ? 'bg-[#3498db] font-bold text-white' : 'hover:bg-[#34495e]'}">
                                    <span class="mr-3">üìã</span> Assessment Map
                                </a>
                                <a href="#" onclick="event.preventDefault(); setTab('sessions')" class="nav-link flex items-center px-6 py-3 transition-colors ${currentTab === 'sessions' ? 'bg-[#3498db] font-bold text-white' : 'hover:bg-[#34495e]'}">
                                    <span class="mr-3">üéØ</span> Support Sessions
                                </a>
                                <a href="#" onclick="event.preventDefault(); setTab('hub')" class="nav-link flex items-center px-6 py-3 transition-colors ${currentTab === 'hub' ? 'bg-[#3498db] font-bold text-white' : 'hover:bg-[#34495e]'}">
                                    <span class="mr-3">üìö</span> Study Hub
                                </a>
                                <a href="#" onclick="event.preventDefault(); setTab('assets')" class="nav-link flex items-center px-6 py-3 transition-colors ${currentTab === 'assets' ? 'bg-[#3498db] font-bold text-white' : 'hover:bg-[#34495e]'}">
                                    <span class="mr-3">üì§</span> Upload Queue
                                </a>

                                <div class="nav-section-header">Management</div>
                                <a href="#" onclick="event.preventDefault(); setTab('campaign-approvals')" class="nav-link flex items-center px-6 py-3 transition-colors ${currentTab === 'campaign-approvals' ? 'bg-[#3498db] font-bold text-white' : 'hover:bg-[#34495e]'}">
                                    <span class="mr-3">‚úÖ</span> Campaign Approvals
                                </a>
                                <a href="#" onclick="event.preventDefault(); setTab('strategic')" class="nav-link flex items-center px-6 py-3 transition-colors ${currentTab === 'strategic' ? 'bg-[#3498db] font-bold text-white' : 'hover:bg-[#34495e]'}">
                                    <span class="mr-3">üìä</span> Strategic View
                                </a>
                                <a href="#" onclick="event.preventDefault(); setTab('sop-management')" class="nav-link flex items-center px-6 py-3 transition-colors ${currentTab === 'sop-management' ? 'bg-[#3498db] font-bold text-white' : 'hover:bg-[#34495e]'}">
                                    <span class="mr-3">‚öôÔ∏è</span> SOP Management
                                </a>
                            ` : `
                                ${tabs.map(t => `
                                    <a href="#" onclick="event.preventDefault(); setTab('${t.id}')" class="nav-link flex items-center px-6 py-3 transition-colors relative ${currentTab === t.id ? 'bg-[#3498db] font-bold text-white' : 'hover:bg-[#34495e]'}">
                                        <span class="mr-3">${t.icon}</span> ${t.label}
                                        ${t.id === 'inbox' && unreadCount > 0 ? `<span class="notification-badge">${unreadCount}</span>` : ''}
                                    </a>
                                `).join('')}
                            `}
                        </nav>
                    </aside>

                    <main class="flex-1 md:ml-[240px] p-4 md:p-8 w-full">
                        <div class="max-w-4xl mx-auto mt-12 md:mt-0">
                            ${await renderTabContent()}
                        </div>
                    </main>
                </div>
            `;
        }

        async function renderTabContent() {
            const { currentTab, user } = state;
            switch (currentTab) {
                case 'overview': return await renderRoleDashboard();
                case 'inbox': return await renderInboxView();
                case 'user-management': return await renderUserManagementView();
                case 'queue': return await renderContentManagerQueue();
                case 'campaigns':
                    if (user.role === 'crm') return renderCampaignCoordination();
                    if (user.role === 'marketing') return renderMarketingCampaigns();
                    return await renderCampaignView('own');
                case 'campaign-approvals': return await renderCampaignView('approvals');
                case 'assets': return await renderAssetView();
                case 'assessments': return await renderAssessmentMap();
                case 'sessions': return await renderSupportSessions();
                case 'sop-management': return renderSopManagementView();
                case 'hub': return await renderSubjectHub();
                case 'strategic': return await renderAssessmentWeekView();
                default: return renderPlaceholderView(currentTab);
            }
        }

        function initDashboardBehaviors() {
            // Re-bind hamburger button if needed (though it's in sidebar-toggle.js)
            // But we can also do it here for full control
        }

        // Helper function to assign icons
        function getSopIcon(linkText) {
            if (linkText.includes('Planning')) return 'üìã';
            if (linkText.includes('Delivery')) return 'üéì';
            if (linkText.includes('Asset') || linkText.includes('Building')) return 'üìù';
            if (linkText.includes('Video') || linkText.includes('Creation')) return 'üé•';
            if (linkText.includes('Approval')) return '‚úÖ';
            if (linkText.includes('Capacity')) return 'üìä';
            if (linkText.includes('Repurposing')) return '‚ôªÔ∏è';
            if (linkText.includes('Calendar')) return 'üìÖ';
            if (linkText.includes('Quality')) return '‚≠ê';
            if (linkText.includes('Backlog')) return 'üì¶';
            return 'üìÑ';
        }

        // ‚îÄ‚îÄ Role Dashboards (Week 5) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // ‚îÄ‚îÄ Role Dashboards (Week 5) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function renderRoleDashboard() {
            const { user, dashboardData: counts, sopLinks } = state;
            if (!counts) return '<div class="text-center py-12 text-gray-400 text-sm">Loading dashboard...</div>';

            const metricsHtml = Object.entries(counts).map(([key, count]) => {
                let hint = '';
                const idStr = key.replace(/_/g, '-').toLowerCase() + '-count';

                if (user.role === 'tutor') {
                    if (key === 'pending_campaigns') hint = '<small class="metric-hint metric-hint-neutral">Waiting for HOD review</small>';
                    else if (key === 'pending_assets') hint = '<small class="metric-hint metric-hint-neutral">Awaiting CM approval</small>';
                    else if (key === 'upcoming_sessions') hint = `<small class="metric-hint metric-hint-action"><a href="#" onclick="event.preventDefault(); setTab('sessions');">View schedule ‚Üí</a></small>`;
                } else if (isHODOrAdmin(user)) {
                    if (key === 'pending_campaign_approvals') {
                        hint = count > 0
                            ? `<small class="metric-hint metric-hint-action"><a href="#" onclick="event.preventDefault(); setTab('campaigns');">Review ${count} campaign${count > 1 ? 's' : ''} ‚Üí</a></small>`
                            : '<small class="metric-hint metric-hint-success">‚úì All campaigns reviewed</small>';
                    } else if (key === 'pending_asset_approvals') {
                        hint = count > 0
                            ? `<small class="metric-hint metric-hint-action"><a href="#" onclick="event.preventDefault(); setTab('queue');">Review ${count} asset${count > 1 ? 's' : ''} ‚Üí</a></small>`
                            : '<small class="metric-hint metric-hint-success">‚úì All assets reviewed</small>';
                    } else if (key === 'unresolved_gap_logs') {
                        hint = count > 0
                            ? `<small class="metric-hint metric-hint-action"><a href="#" onclick="event.preventDefault(); setTab('sessions');">Review gaps ‚Üí</a></small>`
                            : '<small class="metric-hint metric-hint-success">No urgent student issues</small>';
                    }
                }

                return `
                    <div class="metric-card p-6 bg-white border rounded-xl shadow-sm text-center flex flex-col justify-center h-32">
                        <div id="${idStr}" class="text-4xl font-black mb-2 tracking-tighter">${count}</div>
                        <div class="text-[10px] font-bold text-gray-400 uppercase tracking-widest leading-tight">${key.replace(/_/g, ' ')}</div>
                        ${hint}
                    </div>
                `;
            }).join('');

            return `
                <div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                        ${metricsHtml}
                        ${Object.keys(counts).length === 0 ? '<div class="col-span-full text-center py-12 text-gray-400 text-sm italic">Metrics currently unavailable for your role.</div>' : ''}
                    </div>

                    ${user.role === 'tutor' ? `
                        <div class="mt-8">
                            <div class="quick-start">
                                <h1 class="text-2xl font-black tracking-tight mb-2">Getting Started</h1>
                                <p class="intro-text">Welcome to TSH PORTAL! This page explains how to use the system.</p>
                                <div class="instruction-section">
                                    <h3 class="section-title">üì¢ Campaign Management</h3>
                                    <ul class="help-list">
                                        <li><strong>Submit:</strong> <span class="action-path">Campaigns ‚Üí "+ New"</span></li>
                                        <li><strong>Review:</strong> <span class="action-path">Campaigns ‚Üí Status badge</span></li>
                                    </ul>
                                </div>
                                <div class="instruction-section">
                                    <h3 class="section-title">üì§ Content & Materials</h3>
                                    <ul class="help-list">
                                        <li><strong>Upload:</strong> <span class="action-path">Upload Queue ‚Üí "+ Asset"</span></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    ` : ''}

                    ${isHODOrAdmin(user) ? `
                        <div class="mt-8">
                            <div class="quick-start">
                                <h1 class="text-2xl font-black tracking-tight mb-2">Management Oversight</h1>
                                <p class="intro-text">Review tutor work and manage capacity.</p>
                                <div class="instruction-section">
                                    <h3 class="section-title">‚öôÔ∏è Review & Approvals</h3>
                                    <ul class="help-list">
                                        <li><strong>Campaigns:</strong> <span class="action-path">Management ‚Üí Campaign Approvals</span></li>
                                        <li><strong>SOPs:</strong> <span class="action-path">Management ‚Üí SOP Management</span></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    ` : ''}

                    <div class="mt-12">
                        <h2 class="text-lg font-bold mb-4">Quick SOP Access</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                            ${sopLinks.map(link => `
                                <a href="${link.sop_url}" target="_blank" class="sop-card p-4 bg-white border rounded-lg hover:border-blue-400 transition-colors flex items-center">
                                    <span class="text-2xl mr-4">${getSopIcon(link.link_text)}</span>
                                    <div>
                                        <div class="font-bold text-sm">${link.link_text}</div>
                                        <div class="text-[10px] text-gray-400 font-mono">${link.sop_code || 'SOP'}</div>
                                    </div>
                                </a>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // --- User Management Component ---
        async function renderUserManagementView() {
            if (!state.users) {
                state.users = await api.getUsers({ status: state.userFilter === 'pending' ? 'pending' : '' });
            }

            const { users, userFilter, userErr } = state;

            return `
                <div class="user-management-container">
                    <h2 class="font-bold mb-6 text-xs uppercase text-gray-400 tracking-widest">User Management & Approvals</h2>

                    <div class="view-tabs">
                        <button class="tab-btn ${userFilter === 'pending' ? 'active' : ''}" onclick="setUserFilter('pending')">
                            Pending ${users.length > 0 && userFilter === 'pending' ? `<span class="badge">${users.length}</span>` : ''}
                        </button>
                        <button class="tab-btn ${userFilter === 'all' ? 'active' : ''}" onclick="setUserFilter('all')">
                            All Users
                        </button>
                    </div>

                    ${userErr ? `<div class="bg-red-50 text-red-600 p-3 rounded mb-4 text-sm">${userErr}</div>` : ''}

                    ${userFilter === 'pending' ? `
                        <div class="pending-list">
                            ${users.length === 0 ? '<p class="empty-state">No pending registrations</p>' : ''}
                            ${users.map(u => `
                                <div class="user-card pending-card">
                                    <div class="user-info">
                                        <h3>${u.name}</h3>
                                        <p><strong>Email:</strong> ${u.email}</p>
                                        <p><strong>Subjects:</strong> ${u.subjects ? (typeof u.subjects === 'string' ? JSON.parse(u.subjects).join(', ') : u.subjects.join(', ')) : 'None'}</p>
                                        <p><strong>Registered:</strong> ${new Date(u.created_at).toLocaleDateString()}</p>
                                    </div>
                                    <div class="user-actions">
                                        <button onclick="approveUser(${u.id})" class="btn-success">Approve</button>
                                        <button onclick="rejectUser(${u.id})" class="btn-danger">Reject</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : `
                        <div class="overflow-x-auto rounded-lg border border-gray-200">
                            <table class="users-table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Role</th>
                                        <th>Subjects</th>
                                        <th>Status</th>
                                        <th>Created</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${users.map(u => `
                                        <tr>
                                            <td class="font-bold">${u.name}</td>
                                            <td>${u.email}</td>
                                            <td><span class="role-badge role-${u.role}">${u.role}</span></td>
                                            <td class="text-xs">${u.subjects ? (typeof u.subjects === 'string' ? JSON.parse(u.subjects).join(', ') : u.subjects.join(', ')) : '‚Äî'}</td>
                                            <td><span class="status-badge status-${u.account_status}">${u.account_status}</span></td>
                                            <td class="text-gray-400 text-xs">${new Date(u.created_at).toLocaleDateString()}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `}
                </div>
            `;
        }

        window.setUserFilter = async (filter) => {
            state.userFilter = filter;
            state.users = null; // Force reload
            renderApp();
        };

        window.approveUser = async (id) => {
            try {
                await api.approveUser(id);
                state.users = null;
                renderApp();
            } catch (e) {
                state.userErr = e.message;
                renderApp();
            }
        };

        window.rejectUser = async (id) => {
            const reason = prompt('Please enter rejection reason:');
            if (reason === null) return;
            try {
                await api.rejectUser(id, reason);
                state.users = null;
                renderApp();

            } catch (e) {
                alert('Action failed: ' + e.message);
            }
        };

        // ‚îÄ‚îÄ Campaigns View (Week 1 & 6) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function renderCampaignView(viewMode) {
            if (!state.campaigns) {
                const d = await api.getCampaigns({ mode: viewMode });
                state.campaigns = d.campaigns || [];
            }
            const { campaigns } = state;
            const user = state.user;

            return `
                    <div class="space-y-6">
                        <div class="flex justify-between items-center">
                            <h2 class="font-black text-xl italic uppercase tracking-tighter">${viewMode === 'approvals' ? 'Campaign Approvals' : 'My Campaigns'}</h2>
                            ${viewMode === 'own' && (user.role === 'tutor' || user.role === 'admin') ? `
                                <button onclick="window.showNewCampaignForm = true; renderApp();" class="bg-black text-white px-4 py-2 rounded text-xs font-black uppercase hover:bg-gray-800 transition-colors">
                                    + New Campaign
                                </button>
                            ` : ''}
                        </div>

                        ${window.showNewCampaignForm ? renderCampaignForm() : ''}

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${campaigns.length === 0 ? '<div class="col-span-full py-20 text-center border-2 border-dashed border-gray-100 rounded-2xl text-gray-400 text-sm italic">No campaigns found.</div>' : ''}
                            ${campaigns.map(c => `
                                <div class="p-6 bg-white border rounded-xl shadow-sm space-y-4">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <span class="text-[8px] font-black px-2 py-0.5 rounded bg-gray-50 text-gray-400 uppercase">${c.subject}</span>
                                            <h3 class="font-bold text-lg mt-1">${c.topic}</h3>
                                        </div>
                                        <span class="text-[10px] font-black uppercase px-2 py-1 rounded border ${c.status === 'approved' ? 'bg-green-50 text-green-600 border-green-100' : c.status === 'rejected' ? 'bg-red-50 text-red-600 border-red-100' : 'bg-orange-50 text-orange-600 border-orange-100'}">
                                            ${c.status}
                                        </span>
                                    </div>
                                    <div class="text-xs text-gray-600 space-y-1">
                                        <p><strong>Target Date:</strong> ${new Date(c.target_date).toLocaleDateString()}</p>
                                        <p><strong>Outcomes:</strong> ${c.outcomes || '‚Äî'}</p>
                                    </div>
                                    ${viewMode === 'approvals' && (c.status === 'pending' || c.status === 'pending_hod') ? `
                                        <div class="pt-4 border-t flex gap-2">
                                            <button onclick="handleCampaignAction(${c.id}, 'approved')" class="flex-1 bg-green-600 text-white py-2 rounded text-[10px] font-black uppercase hover:bg-green-700 transition-colors">Approve</button>
                                            <button onclick="handleCampaignAction(${c.id}, 'rejected')" class="flex-1 bg-red-600 text-white py-2 rounded text-[10px] font-black uppercase hover:bg-red-700 transition-colors">Reject</button>
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
        }

        function renderCampaignForm() {
            return `
                    <div class="mb-8 p-6 bg-white border rounded-2xl shadow-sm">
                        <h3 class="font-bold mb-4 italic text-gray-800">Campaign Intake</h3>
                        <form onsubmit="handleCreateCampaign(event)" class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div class="space-y-1">
                                    <label class="text-[10px] font-bold text-gray-400 uppercase">Subject/Course</label>
                                    <input type="text" name="subject" placeholder="e.g. G12 Math" required class="w-full p-2.5 border rounded-lg text-sm bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition-all" />
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <div class="space-y-1">
                                        <label class="text-[10px] font-bold text-gray-400 uppercase">Target Date</label>
                                        <input type="date" name="target_date" class="w-full p-2.5 border rounded-lg text-sm bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition-all" />
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-[10px] font-bold text-gray-400 uppercase">Target Time</label>
                                        <input type="time" name="target_time" class="w-full p-2.5 border rounded-lg text-sm bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition-all" />
                                    </div>
                                </div>
                            </div>
                            
                            <div class="space-y-1">
                                <label class="text-[10px] font-bold text-gray-400 uppercase">Campaign Topic</label>
                                <input type="text" name="topic" placeholder="e.g. Calculus Differentiation" required class="w-full p-2.5 border rounded-lg text-sm bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition-all" />
                            </div>

                            <div class="space-y-1 relative">
                                <label class="text-[10px] font-bold text-gray-400 uppercase">Examiner Trick/Pattern</label>
                                <textarea name="trick_pattern" maxlength="500" placeholder="Describe the common examiner traps..." 
                                    oninput="document.getElementById('trick-count').innerText = this.value.length + '/500'"
                                    class="w-full p-2.5 border rounded-lg text-sm bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition-all h-20" rows="2"></textarea>
                                <span id="trick-count" class="absolute right-2 bottom-2 text-[9px] text-gray-400">0/500</span>
                            </div>

                            <div class="space-y-1 relative">
                                <label class="text-[10px] font-bold text-gray-400 uppercase">Target Learning Outcomes</label>
                                <textarea name="outcomes" maxlength="500" placeholder="What will students master?" required
                                    oninput="document.getElementById('outcomes-count').innerText = this.value.length + '/500'"
                                    class="w-full p-2.5 border rounded-lg text-sm bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition-all h-20" rows="2"></textarea>
                                <span id="outcomes-count" class="absolute right-2 bottom-2 text-[9px] text-gray-400">0/500</span>
                            </div>

                            <div class="flex gap-3 pt-2">
                                <button type="submit" id="submit-campaign-btn" class="flex-1 bg-blue-600 text-white p-3 rounded-lg font-bold text-sm hover:bg-blue-700 transition-colors shadow-sm">Submit to HOD</button>
                                <button type="button" onclick="window.showNewCampaignForm = false; renderApp();" class="px-6 border p-3 rounded-lg font-bold text-sm text-gray-500 hover:bg-gray-50 transition-colors">Cancel</button>
                            </div>
                        </form>
                    </div>
                `;
        }

        window.handleCreateCampaign = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submit-campaign-btn');
            if (btn) btn.disabled = true;
            if (btn) btn.innerText = 'Submitting...';

            const fd = new FormData(e.target);
            const data = Object.fromEntries(fd);
            try {
                await api.createCampaign(data);
                window.showNewCampaignForm = false;
                state.campaigns = null;
                renderApp();
            } catch (e) {
                alert(e.message);
                if (btn) btn.disabled = false;
                if (btn) btn.innerText = 'Submit to HOD';
            }
        };

        window.handleCampaignAction = async (id, status) => {
            const reason = status === 'rejected' ? prompt('Reason for rejection:') : '';
            if (status === 'rejected' && reason === null) return;
            try {
                await api.updateCampaign(id, status, reason);
                state.campaigns = null;
                renderApp();
            } catch (e) { alert(e.message); }
        };

        // ‚îÄ‚îÄ Asset View (Week 2 & 7) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function renderAssetView() {
            if (!state.assets) {
                const d = await api.getAssets();
                state.assets = d.assets || [];
            }
            const { assets } = state;

            return `
                    <div class="space-y-6">
                        <div class="flex justify-between items-center">
                            <h2 class="font-black text-xl italic uppercase tracking-tighter">Asset Upload Queue</h2>
                            <button onclick="window.showNewAssetForm = true; renderApp();" class="bg-black text-white px-4 py-2 rounded text-xs font-black uppercase hover:bg-gray-800 transition-colors">
                                + Upload Asset
                            </button>
                        </div>

                        ${window.showNewAssetForm ? renderAssetForm() : ''}

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${assets.length === 0 ? '<div class="col-span-full py-20 text-center border-2 border-dashed border-gray-100 rounded-2xl text-gray-400 text-sm italic">No assets uploaded.</div>' : ''}
                            ${assets.map(a => `
                                <div class="p-6 bg-white border rounded-xl shadow-sm space-y-3 relative overflow-hidden">
                                    <div class="absolute top-0 right-0 p-3 bg-gray-50 border-b border-l text-[8px] font-black uppercase text-gray-400">${a.asset_type}</div>
                                    <div>
                                        <p class="text-[10px] font-bold text-blue-500 uppercase mb-1">${a.subject}</p>
                                        <h3 class="font-bold">${a.topic}</h3>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="text-[10px] uppercase font-black px-2 py-0.5 border rounded-full ${a.status === 'published' ? 'bg-green-50 text-green-600 border-green-100' : 'bg-gray-50 text-gray-400'}">${a.status}</span>
                                        <a href="${a.drive_link}" target="_blank" class="text-[10px] font-black text-blue-600 hover:underline">Link ‚Üó</a>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
        }

        function renderAssetForm() {
            const categories = [
                { id: 'free_asset', title: 'üìπ Free Class Content', desc: 'YouTube/Social repurposing' },
                { id: 'hub_asset', title: 'üìö Hub Resource', desc: 'Study Hub material - requires review' }
            ];
            const assetTypes = [
                { id: 'slides', label: 'Slides' },
                { id: 'worksheet', label: 'Worksheet' },
                { id: 'recording', label: 'Recording' },
                { id: 'marking_key', label: 'Marking Key' },
                { id: 'practice_bank', label: 'Practice Bank' },
                { id: 'other', label: 'Other' }
            ];

            return `
                <div class="mb-8 p-6 bg-white border border-gray-200 rounded-2xl shadow-sm">
                    <h3 class="font-bold mb-4 italic text-gray-800">Asset Submission</h3>
                    <form onsubmit="handleCreateAsset(event)" class="space-y-6">
                        <!-- Category Selection -->
                        <div class="space-y-3">
                            <label class="block text-[10px] font-bold text-gray-400 uppercase">Asset Category <span class="text-red-500">*</span></label>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                ${categories.map(c => `
                                    <label class="flex items-start gap-3 p-3 border rounded-xl cursor-pointer hover:bg-gray-50 bg-white transition-colors has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50">
                                        <input type="radio" name="asset_category" value="${c.id}" class="mt-1 accent-blue-600" required onchange="updateAssetFormGuidance('${c.id}')" />
                                        <div>
                                            <span class="font-bold text-sm block">${c.title}</span>
                                            <span class="text-[10px] text-gray-500 block uppercase">${c.desc}</span>
                                        </div>
                                    </label>
                                `).join('')}
                            </div>
                            <div id="asset-form-guidance" class="hidden mt-2 p-3 rounded-lg text-xs"></div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-1">
                                <label class="text-[10px] font-bold text-gray-400 uppercase">Subject</label>
                                <input type="text" name="subject" placeholder="e.g. Math" required class="w-full p-2.5 border rounded-lg text-sm bg-gray-50 focus:bg-white outline-none focus:ring-2 focus:ring-blue-500 transition-all" />
                            </div>
                            <div class="space-y-1">
                                <label class="text-[10px] font-bold text-gray-400 uppercase">Topic</label>
                                <input type="text" name="topic" placeholder="e.g. Fractions" required class="w-full p-2.5 border rounded-lg text-sm bg-gray-50 focus:bg-white outline-none focus:ring-2 focus:ring-blue-500 transition-all" />
                            </div>
                        </div>

                        <!-- Asset Types Multi-select -->
                        <div class="space-y-3">
                            <label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase">Select Item Types & Provide Links</label>
                            <div class="space-y-3">
                                ${assetTypes.map(t => `
                                    <div class="space-y-2">
                                        <label class="flex items-center gap-2 cursor-pointer group">
                                            <input type="checkbox" class="w-4 h-4 accent-black rounded border-gray-300" onchange="toggleAssetLinkInput(this, '${t.id}')" />
                                            <span class="text-sm font-medium group-hover:text-blue-600 transition-colors">${t.label}</span>
                                        </label>
                                        <div id="link-container-${t.id}" class="hidden ml-6">
                                            <input type="url" name="link_${t.id}" placeholder="Google Drive link for ${t.label}" class="w-full p-2 border rounded-lg text-xs bg-white focus:ring-2 focus:ring-blue-500 outline-none" />
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Tutor Notes -->
                        <div class="space-y-1 relative">
                            <label class="text-[10px] font-bold text-gray-400 uppercase">Tutor Notes (Optional)</label>
                            <textarea name="tutor_notes" maxlength="300" placeholder="Instructions: timestamps, context, things to skip..." 
                                oninput="document.getElementById('notes-count').innerText = this.value.length + '/300'"
                                class="w-full p-2.5 border rounded-lg text-xs bg-gray-50 focus:bg-white outline-none focus:ring-2 focus:ring-blue-500 transition-all h-20" rows="2"></textarea>
                            <span id="notes-count" class="absolute right-2 bottom-2 text-[9px] text-gray-400">0/300</span>
                        </div>

                        <div class="flex items-center gap-4 pt-4 border-t">
                            <button type="submit" id="submit-asset-btn" class="flex-1 bg-blue-600 text-white p-3 rounded-lg font-bold text-sm hover:bg-blue-700 transition-colors shadow-sm">Upload to Queue</button>
                            <button type="button" onclick="window.showNewAssetForm = false; renderApp();" class="px-6 border p-3 rounded-lg font-bold text-sm text-gray-500 hover:bg-gray-50 transition-colors">Cancel</button>
                        </div>
                    </form>
                </div>
            `;
        }

        window.updateAssetFormGuidance = (cat) => {
            const el = document.getElementById('asset-form-guidance');
            if (!el) return;
            el.classList.remove('hidden', 'bg-blue-50', 'text-blue-800', 'bg-green-50', 'text-green-800', 'border', 'border-blue-200', 'border-green-200');
            if (cat === 'free_asset') {
                el.innerHTML = `<strong>Selected: Free Class Content</strong><p class="mt-1">‚Üí Goes directly to Content Manager for YouTube/Social repurposing. No further review required.</p>`;
                el.classList.add('bg-blue-50', 'text-blue-800', 'border', 'border-blue-200');
            } else {
                el.innerHTML = `<strong>Selected: Hub Resource</strong><p class="mt-1">‚Üí Quality review by Content Manager before publishing to Study Hub. You'll be notified of progress.</p>`;
                el.classList.add('bg-green-50', 'text-green-800', 'border', 'border-green-200');
            }
        };

        window.toggleAssetLinkInput = (checkbox, id) => {
            const container = document.getElementById(`link-container-${id}`);
            const input = container?.querySelector('input');
            if (!container || !input) return;
            if (checkbox.checked) {
                container.classList.remove('hidden');
                input.required = true;
            } else {
                container.classList.add('hidden');
                input.required = false;
                input.value = '';
            }
        };

        window.handleCreateAsset = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submit-asset-btn');
            if (btn) btn.disabled = true;
            if (btn) btn.innerText = 'Uploading...';

            try {
                const fd = new FormData(e.target);
                const formData = Object.fromEntries(fd);
                const subject = formData.subject;
                const topic = formData.topic;
                const category = formData.asset_category;
                const notes = formData.tutor_notes;

                // Collect all selected asset types and their links
                const assetTypes = ['slides', 'worksheet', 'recording', 'marking_key', 'practice_bank', 'other'];
                const batch = [];

                assetTypes.forEach(type => {
                    const link = formData[`link_${type}`];
                    if (link && link.trim() !== '') {
                        batch.push({
                            subject,
                            topic,
                            asset_type: type,
                            drive_link: link,
                            asset_category: category,
                            tutor_notes: notes || null
                        });
                    }
                });

                if (batch.length === 0) {
                    throw new Error('Please select at least one asset type and provide a link.');
                }

                await api.createAsset(batch);
                window.showNewAssetForm = false;
                state.assets = null;
                renderApp();
            } catch (e) {
                alert(e.message);
                if (btn) btn.disabled = false;
                if (btn) btn.innerText = 'Upload to Queue';
            }
        };

        // ‚îÄ‚îÄ Assessment Map (Week 3 & 7) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function renderAssessmentMap() {
            if (!state.assessments) {
                const d = await api.getAssessments();
                state.assessments = d.assessments || [];
            }
            const { assessments } = state;

            return `
                    <div class="space-y-6">
                        <div class="flex justify-between items-center">
                            <h2 class="font-black text-xl italic uppercase tracking-tighter">Strategic Assessment Map</h2>
                            <button onclick="window.showNewAssessmentForm = true; renderApp();" class="bg-red-600 text-white px-4 py-2 rounded text-xs font-black uppercase hover:bg-red-700 transition-colors">
                                + Add Assessment
                            </button>
                        </div>

                        ${window.showNewAssessmentForm ? `
                            <div class="mb-8 p-6 bg-red-50 border border-red-100 rounded-2xl shadow-sm">
                                <h3 class="font-black text-sm uppercase mb-4 text-red-900">Log Upcoming Assessment Milestone</h3>
                                <form onsubmit="handleCreateAssessment(event)" class="space-y-4">
                                    <div class="grid grid-cols-2 gap-4">
                                        <div class="space-y-1">
                                            <label class="text-[10px] font-bold text-gray-400 uppercase">Subject/Course</label>
                                            <input type="text" name="subject" placeholder="e.g. G12 Math" required class="w-full p-2.5 border rounded-lg text-sm bg-white" />
                                        </div>
                                        <div class="space-y-1">
                                            <label class="text-[10px] font-bold text-gray-400 uppercase">Institution</label>
                                            <input type="text" name="institution" placeholder="e.g. Cambridge, CAPS" required class="w-full p-2.5 border rounded-lg text-sm bg-white" />
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-3 gap-4">
                                        <div class="space-y-1">
                                            <label class="text-[10px] font-bold text-gray-400 uppercase">Type</label>
                                            <select name="type" required class="w-full p-2.5 border rounded-lg text-sm bg-white">
                                                <option value="exam">Exam</option>
                                                <option value="test">Test</option>
                                                <option value="quiz">Quiz</option>
                                                <option value="mock">Mock</option>
                                                <option value="topic">Topic Test</option>
                                            </select>
                                        </div>
                                        <div class="space-y-1">
                                            <label class="text-[10px] font-bold text-gray-400 uppercase">Assessment Date</label>
                                            <input type="date" name="date" required class="w-full p-2.5 border rounded-lg text-sm bg-white" />
                                        </div>
                                        <div class="space-y-1">
                                            <label class="text-[10px] font-bold text-gray-400 uppercase">Prep Window</label>
                                            <input type="text" name="campaign_window" placeholder="e.g. 2 weeks" class="w-full p-2.5 border rounded-lg text-sm bg-white" />
                                        </div>
                                    </div>

                                    <div class="flex gap-3 pt-2">
                                        <button type="submit" class="flex-1 bg-red-600 text-white p-3 rounded-lg font-bold text-sm hover:bg-red-700 transition-colors shadow-sm">Pin to Map</button>
                                        <button type="button" onclick="window.showNewAssessmentForm = false; renderApp();" class="px-6 border p-3 rounded-lg font-bold text-sm text-gray-500 hover:bg-gray-50 transition-colors">Cancel</button>
                                    </div>
                                </form>
                            </div>
                        ` : ''}

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            ${assessments.length === 0 ? '<div class="col-span-full py-20 text-center border-2 border-dashed border-gray-100 rounded-2xl text-gray-400 text-sm italic">No assessments found.</div>' : ''}
                            ${assessments.map(a => `
                                <div class="p-6 bg-white border rounded-xl shadow-sm space-y-3">
                                    <div class="flex justify-between items-start">
                                        <span class="text-[8px] font-black px-2 py-0.5 rounded bg-red-50 text-red-600 uppercase tracking-widest">${a.type}</span>
                                        <span class="text-[8px] font-bold text-gray-400 uppercase">${a.institution}</span>
                                    </div>
                                    <h4 class="font-bold text-lg">${a.subject}</h4>
                                    <div class="flex items-center gap-2 text-xs font-black text-red-900 bg-red-50 p-2 rounded-lg">
                                        <span>üìÖ</span> ${new Date(a.date).toLocaleDateString()}
                                    </div>
                                    ${a.campaign_window ? `<p class="text-[10px] text-gray-400 font-bold uppercase tracking-tight">Window: ${a.campaign_window}</p>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
        }

        window.handleCreateAssessment = async (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            const data = Object.fromEntries(fd);
            try {
                await api.createAssessment(data);
                window.showNewAssessmentForm = false;
                state.assessments = null;
                renderApp();
            } catch (e) { alert(e.message); }
        };

        // ‚îÄ‚îÄ Support Sessions (Week 3 & 7) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function renderSupportSessions() {
            if (!state.sessions) {
                const d = await api.getSessions();
                state.sessions = d.sessions || [];
            }
            const { sessions } = state;

            return `
                    <div class="space-y-6">
                        <div class="flex justify-between items-center">
                            <h2 class="font-black text-xl italic uppercase tracking-tighter">Support & Gap Logs</h2>
                            <button onclick="window.showNewSessionForm = true; renderApp();" class="bg-blue-600 text-white px-4 py-2 rounded text-xs font-black uppercase hover:bg-blue-700 transition-colors">
                                + Log Support Session
                            </button>
                        </div>

                        ${window.showNewSessionForm ? `
                            <div class="mb-8 p-6 bg-blue-50 border border-blue-100 rounded-2xl shadow-sm">
                                <h3 class="font-black text-sm uppercase mb-4 text-blue-900">New Support Session Log</h3>
                                <form onsubmit="handleCreateSession(event)" class="space-y-4">
                                    <div class="space-y-1">
                                        <label class="text-[10px] font-bold text-gray-400 uppercase">Subject/Course</label>
                                        <input type="text" name="subject" placeholder="e.g. G12 Math" required class="w-full p-2.5 border rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none" />
                                    </div>
                                    
                                    <div class="grid grid-cols-2 gap-4">
                                        <div class="space-y-1">
                                            <label class="text-[10px] font-bold text-gray-400 uppercase">Session Date</label>
                                            <input type="date" name="session_date" required class="w-full p-2.5 border rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none" />
                                        </div>
                                        <div class="space-y-1">
                                            <label class="text-[10px] font-bold text-gray-400 uppercase">Target Assessment Date</label>
                                            <input type="date" name="assessment_date" class="w-full p-2.5 border rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none" />
                                        </div>
                                    </div>

                                    <div class="space-y-1">
                                        <label class="text-[10px] font-bold text-gray-400 uppercase">Confusion Topics / Learning Gaps</label>
                                        <textarea name="confusion_topics" placeholder="Describe what the student found challenging..." required 
                                            class="w-full p-2.5 border rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none h-24"></textarea>
                                    </div>

                                    <div class="flex gap-3 pt-2">
                                        <button type="submit" class="flex-1 bg-blue-600 text-white p-3 rounded-lg font-bold text-sm hover:bg-blue-700 transition-colors shadow-sm">Save Log</button>
                                        <button type="button" onclick="window.showNewSessionForm = false; renderApp();" class="px-6 border p-3 rounded-lg font-bold text-sm text-gray-500 hover:bg-gray-50 transition-colors">Cancel</button>
                                    </div>
                                </form>
                            </div>
                        ` : ''}

                        <div class="grid grid-cols-1 gap-4">
                            ${sessions.length === 0 ? '<div class="col-span-full py-20 text-center border-2 border-dashed border-gray-100 rounded-2xl text-gray-400 text-sm italic">No support sessions logged.</div>' : ''}
                            ${sessions.map(s => `
                                <div class="p-5 bg-white border rounded-xl shadow-sm flex justify-between items-center group hover:border-blue-200 transition-all">
                                    <div class="space-y-1">
                                        <div class="flex items-center gap-2">
                                            <span class="text-[10px] font-black uppercase text-blue-600 bg-blue-50 px-2 py-0.5 rounded">${s.subject}</span>
                                            <span class="text-[10px] font-bold text-gray-400 uppercase tracking-tighter">${s.status}</span>
                                        </div>
                                        <div class="flex gap-4 text-[10px] font-bold text-gray-400 uppercase">
                                            <span>üìÖ Session: ${new Date(s.session_date).toLocaleDateString()}</span>
                                            ${s.assessment_date ? `<span class="text-red-400">üéØ Target: ${new Date(s.assessment_date).toLocaleDateString()}</span>` : ''}
                                        </div>
                                        <p class="text-xs mt-2 text-gray-600 border-l-2 border-blue-100 pl-3 italic">"${s.confusion_topics}"</p>
                                    </div>
                                    ${s.status === 'scheduled' ? `
                                        <button onclick="handleCompleteSession(${s.id})" class="text-[10px] font-black bg-green-600 text-white px-6 py-2.5 rounded-lg uppercase hover:bg-green-700 transition-colors shadow-sm">Complete</button>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
        }

        window.handleCreateSession = async (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            const data = Object.fromEntries(fd);
            try {
                await api.createSession(data);
                window.showNewSessionForm = false;
                state.sessions = null;
                renderApp();
            } catch (e) { alert(e.message); }
        };

        window.handleCompleteSession = async (id) => {
            const log = prompt('Post-session summary/outcome:');
            if (log === null) return;
            try {
                await api.updateSession(id, { status: 'completed', post_session_log: log });
                state.sessions = null;
                renderApp();
            } catch (e) { alert(e.message); }
        };

        // ‚îÄ‚îÄ Campaign Coordination (CRM) ‚îÄ‚îÄ
        async function renderCampaignCoordination() {
            if (!state.campaigns) {
                const d = await api.getCampaigns({ status: 'approved' });
                state.campaigns = d.campaigns || [];
            }
            const { campaigns } = state;

            return `
                    <div class="space-y-6">
                        <h2 class="font-black text-xl italic uppercase tracking-tighter">CRM Coordination Hub</h2>
                        <div class="grid grid-cols-1 gap-4">
                            ${campaigns.map(c => `
                                <div class="p-6 bg-white border rounded-xl shadow-sm flex justify-between items-center">
                                    <div>
                                        <span class="text-[10px] font-black uppercase text-blue-500 bg-blue-50 px-2 py-0.5 rounded">Ready for Promotion</span>
                                        <h3 class="font-bold text-lg mt-1">${c.subject} ¬∑ ${c.topic}</h3>
                                        <p class="text-[10px] text-gray-400 font-bold uppercase mt-1">Target Date: ${new Date(c.target_date).toLocaleDateString()}</p>
                                    </div>
                                    <button onclick="alert('Blast link copied to clipboard!')" class="bg-black text-white px-4 py-2 rounded text-[10px] font-black uppercase transition-transform active:scale-95">Copy Blast Link</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
        }

        // ‚îÄ‚îÄ Marketing Promotion Hub ‚îÄ‚îÄ
        async function renderMarketingCampaigns() {
            if (!state.campaigns || !state.sessions) {
                const [cd, sd] = await Promise.all([api.getCampaigns({ status: 'approved' }), api.getSessions({ upcoming: true })]);
                state.campaigns = cd.campaigns || [];
                state.sessions = sd.sessions || [];
            }
            const { campaigns, sessions } = state;

            return `
                    <div class="space-y-8">
                        <h2 class="font-black text-xl italic uppercase tracking-tighter">Marketing Asset Hub</h2>
                        
                        <section>
                            <p class="text-xs font-black uppercase text-gray-400 tracking-widest mb-4">Live Campaigns</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                ${campaigns.map(c => `
                                    <div class="p-5 bg-white border rounded-xl shadow-sm">
                                        <h4 class="font-bold mb-1">${c.topic}</h4>
                                        <p class="text-[10px] text-gray-400 font-bold uppercase mb-4">${c.subject}</p>
                                        <button class="w-full border-2 border-black p-2 rounded text-[10px] font-black uppercase hover:bg-black hover:text-white transition-all">Download Creative Pack</button>
                                    </div>
                                `).join('')}
                            </div>
                        </section>

                        <section>
                            <p class="text-xs font-black uppercase text-gray-400 tracking-widest mb-4">Support Sessions to Promote</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                ${sessions.map(s => `
                                    <div class="p-5 bg-white border rounded-xl shadow-sm border-dashed">
                                        <h4 class="font-bold mb-1">${s.subject} Support</h4>
                                        <p class="text-[10px] text-gray-400 font-bold uppercase mb-4">${new Date(s.session_date).toLocaleDateString()}</p>
                                        <button class="w-full bg-black text-white p-2 rounded text-[10px] font-black uppercase">Create Booking Link</button>
                                    </div>
                                `).join('')}
                            </div>
                        </section>
                    </div>
                `;
        }

        // ‚îÄ‚îÄ SOP Management View (Week 7.5) ‚îÄ‚îÄ
        async function renderSopManagementView() {
            if (!state.allSops) {
                state.allSops = await api.getSopLinks();
            }
            const { allSops, sopFilter = '' } = state;
            const filtered = sopFilter ? allSops.filter(s => s.target_role === sopFilter) : allSops;

            return `
                    <div class="space-y-6">
                        <div class="flex justify-between items-center">
                            <h2 class="font-black text-xl italic uppercase tracking-tighter">SOP Link Management</h2>
                            <button onclick="alert('Form coming soon')" class="bg-black text-white px-4 py-2 rounded text-xs font-black uppercase">+ New Link</button>
                        </div>

                        <div class="flex gap-2">
                            <button onclick="setSopFilter('')" class="px-4 py-2 rounded-lg text-xs font-black border ${sopFilter === '' ? 'bg-black text-white border-black' : 'text-gray-400 border-gray-100'}">All</button>
                            <button onclick="setSopFilter('tutor')" class="px-4 py-2 rounded-lg text-xs font-black border ${sopFilter === 'tutor' ? 'bg-blue-600 text-white border-blue-600' : 'text-gray-400 border-gray-100'}">Tutors</button>
                            <button onclick="setSopFilter('hod')" class="px-4 py-2 rounded-lg text-xs font-black border ${sopFilter === 'hod' ? 'bg-purple-600 text-white border-purple-600' : 'text-gray-400 border-gray-100'}">HODs</button>
                        </div>

                        <div class="bg-white border rounded-xl shadow-sm overflow-hidden">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50 border-b">
                                    <tr>
                                        <th class="px-6 py-4 text-left font-black uppercase text-[10px] text-gray-400">Link Details</th>
                                        <th class="px-6 py-4 text-left font-black uppercase text-[10px] text-gray-400">Target</th>
                                        <th class="px-6 py-4 text-right font-black uppercase text-[10px] text-gray-400">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-100">
                                    ${filtered.map(l => `
                                        <tr>
                                            <td class="px-6 py-4">
                                                <div class="font-bold">${l.title}</div>
                                                <div class="text-[10px] text-gray-400 truncate max-w-xs">${l.url}</div>
                                            </td>
                                            <td class="px-6 py-4">
                                                <span class="text-[10px] font-black uppercase px-2 py-0.5 rounded ${l.target_role === 'tutor' ? 'bg-blue-50 text-blue-600' : 'bg-purple-50 text-purple-600'}">${l.target_role}</span>
                                            </td>
                                            <td class="px-6 py-4 text-right">
                                                <a href="${l.url}" target="_blank" class="text-xs text-blue-600 font-black uppercase hover:underline">View ‚Üó</a>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
        }

        window.setSopFilter = (role) => {
            state.sopFilter = role;
            renderApp();
        };

        // ‚îÄ‚îÄ Inbox View ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function renderInboxView() {
            if (!state.notifications) {
                const d = await api.getNotifications(state.user.role);
                state.notifications = d.notifications || [];
            }
            const { notifications } = state;

            return `
                <div class="space-y-3">
                    <div class="flex justify-between items-center mb-4">
                        <p class="text-xs font-bold uppercase text-gray-400 tracking-widest">My Inbox</p>
                    </div>
                    ${notifications.map(n => `
                        <div class="p-4 border rounded-xl shadow-sm text-sm flex justify-between items-start ${n.read_status === 'unread' ? 'bg-blue-50 border-blue-200' : 'bg-white border-gray-100'}">
                            <div>
                                <div class="font-medium ${n.read_status === 'unread' ? 'text-blue-900' : 'text-gray-600'}">${n.message}</div>
                                <div class="text-xs mt-1 text-gray-400">${new Date(n.created_at).toLocaleString()}</div>
                            </div>
                            ${n.read_status === 'unread' ? `<button onclick="handleMarkRead(${n.id})" class="text-[10px] bg-blue-600 text-white px-3 py-1.5 rounded font-black uppercase ml-4 shrink-0 transition-colors hover:bg-blue-700">Mark Read</button>` : ''}
                        </div>
                    `).join('')}
                    ${notifications.length === 0 ? '<div class="py-20 text-center border-2 border-dashed border-gray-100 rounded-2xl text-gray-400 text-sm italic">Inbox is empty.</div>' : ''}
                </div>
            `;
        }

        window.handleMarkRead = async (id) => {
            try {
                await api.markNotificationRead(id);
                state.notifications = null;
                renderApp();
            } catch (e) { alert(e.message); }
        };

        // ‚îÄ‚îÄ Content Manager Queue ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function renderContentManagerQueue() {
            if (!state.allAssets) {
                const d = await api.getAssets();
                state.allAssets = d.assets || [];
            }
            const { allAssets, cmTab = 'free' } = state;
            const freeAssets = allAssets.filter(a => a.asset_category === 'free_asset');
            const hubAssets = allAssets.filter(a => a.asset_category === 'hub_asset');

            return `
                <div>
                    <h2 class="font-bold mb-4 text-xs uppercase text-gray-400 tracking-widest">Asset Publish Queue</h2>
                    <div class="flex gap-2 mb-6">
                        <button onclick="setCmTab('free')" class="px-4 py-2 rounded text-sm font-bold ${cmTab === 'free' ? 'bg-blue-600 text-white' : 'border text-gray-600'}">üìπ Free Content</button>
                        <button onclick="setCmTab('hub')" class="px-4 py-2 rounded text-sm font-bold ${cmTab === 'hub' ? 'bg-black text-white' : 'border text-gray-600'}">üìö Hub Resources</button>
                    </div>

                    <div class="space-y-4">
                        ${(cmTab === 'free' ? freeAssets : hubAssets).map(a => `
                            <div class="border p-5 rounded-lg bg-white shadow-sm transition-all hover:shadow-md">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="text-xs font-bold text-gray-400 uppercase mb-1">${a.subject} ¬∑ ${a.asset_type}</p>
                                        <h3 class="font-bold">${a.topic}</h3>
                                        <p class="text-xs text-gray-400">By ${a.tutor_name}</p>
                                    </div>
                                    <span class="text-[10px] font-black uppercase px-2 py-1 border rounded shadow-sm">${a.status.replace(/_/g, ' ')}</span>
                                </div>
                                <a href="${a.drive_link}" target="_blank" class="text-xs text-blue-600 underline mt-2 block font-black">Open Drive Link ‚Üó</a>
                                ${a.status === 'approved' || a.status === 'pending_cm' ? `
                                    <button onclick="handlePublishAsset(${a.id})" class="mt-4 bg-green-600 text-white px-4 py-2 rounded text-xs font-bold uppercase hover:bg-green-700 transition-colors">Publish to Hub</button>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        window.setCmTab = (tab) => {
            state.cmTab = tab;
            renderApp();
        };

        window.handlePublishAsset = async (id) => {
            try {
                await api.publishAsset(id);
                state.allAssets = null;
                renderApp();
            } catch (e) { alert(e.message); }
        };

        // ‚îÄ‚îÄ Study Hub Inventory ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function renderSubjectHub() {
            if (!state.inventory) {
                const d = await api.getHubInventory();
                state.inventory = d.inventory || [];
            }
            const { inventory } = state;

            return `
                <div class="space-y-6">
                    <div class="flex justify-between items-center bg-white p-4 rounded-xl border shadow-sm">
                        <p class="text-xs font-black uppercase text-gray-400 tracking-widest">Master Asset Library</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${inventory.map(a => `
                            <div class="p-5 rounded-2xl bg-white border shadow-sm transition-all hover:shadow-md">
                                <span class="text-[8px] font-black uppercase px-2 py-0.5 rounded bg-blue-50 text-blue-600">${a.asset_type}</span>
                                <h4 class="font-bold text-sm mt-1">${a.topic}</h4>
                                <p class="text-[10px] text-gray-400 font-bold mt-1">By ${a.tutor_name} ¬∑ ${a.subject}</p>
                                <a href="${a.drive_link}" target="_blank" class="mt-3 block text-xs text-blue-600 underline font-black">View Asset ‚Üó</a>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // ‚îÄ‚îÄ Strategic View ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function renderAssessmentWeekView() {
            if (!state.allAssessments || !state.allCampaigns) {
                const [ad, cd] = await Promise.all([api.getAssessments(), api.getCampaigns({ status: 'approved' })]);
                state.allAssessments = ad.assessments || [];
                state.allCampaigns = cd.campaigns || [];
            }
            const { allAssessments: assessments, allCampaigns: campaigns } = state;

            const getWeek = (dateStr) => {
                const d = new Date(dateStr);
                const oneJan = new Date(d.getFullYear(), 0, 1);
                const numberOfDays = Math.floor((d - oneJan) / (24 * 60 * 60 * 1000));
                return Math.ceil((d.getDay() + 1 + numberOfDays) / 7);
            };

            const weeks = Array.from(new Set(assessments.map(a => getWeek(a.date)))).sort((a, b) => a - b);

            return `
                <div class="space-y-6">
                    <h2 class="font-black text-xl italic uppercase tracking-tighter">Academic Strategic View</h2>
                    ${weeks.map(week => `
                        <div class="border rounded-xl p-6 bg-white shadow-sm relative">
                            <div class="absolute top-0 right-0 p-4 bg-gray-50 border-b border-l text-xs font-black uppercase text-gray-400">Week ${week}</div>
                            <h3 class="font-bold text-lg mb-4 text-gray-800">Critical Milestones</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <p class="text-[10px] font-black uppercase text-red-500 mb-3 tracking-widest">Assessments</p>
                                    <div class="space-y-2">
                                        ${assessments.filter(a => getWeek(a.date) === week).map(a => `
                                            <div class="flex justify-between items-center p-3 rounded bg-red-50 border border-red-100">
                                                <span class="text-xs font-bold text-red-900">${a.subject}</span>
                                                <span class="text-[10px] text-red-500 font-medium">${new Date(a.date).toLocaleDateString()}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                <div>
                                    <p class="text-[10px] font-black uppercase text-blue-500 mb-3 tracking-widest">Campaigns</p>
                                    <div class="space-y-2">
                                        ${campaigns.filter(c => getWeek(c.target_date) === week).map(c => `
                                            <div class="flex justify-between items-center p-3 rounded bg-blue-50 border border-blue-100">
                                                <span class="text-xs font-bold text-blue-900">${c.topic}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // --- Entry Point ---
        onInit();
    </script>
</body>

</html>